SDK: [JavaScript](https://github.com/verstka/verstka.io/tree/master/JS-SDK), [PHP](https://github.com/verstka/verstka.io/tree/master/PHP-SDK)

#Verstka API

Верста предлагает разработчикам удобный способ интеграции редактора на сайт по cредствам API

Формат возвращаемых данных (кроме скачивания файлов) JSON и будет иметь следующие поля:

*  `rc` - код результата выполнения (1 - для успешных запросов) 
*  `rm` - сообщение в текстовом виде 
*  `data` - массив возвращаемых данных 

##Редактирование статьи

Для редактирования статьи достаточно отправить POST запрос на URL https://verstka.io/api/open c параметрами:

*  `material_id` - идентификатор материала
*  `user_id` - идентификатор текущего пользователя
*  `html_body` - html статьи (пустой в случае новой статьи)
*  `api-key` - API-key, выдаваемый при подключении к Verstka SaaS API
*  `callback_url` - url адрес на который прийдет запрос при сохранении статьи в редакторе
*  `host_name` - с этого хоста редактор попытается скачать изображения статьи (если `html_body` содержит изображения)
*  `user_ip` - ip адрес текущего пользователя (дополнительный уровень безопасности при открытии редактора)
*  `custom_fields` - массив дополнительных параметров в формате JSON для включения дополнительных функций редактора

Возможные ключи массива `custom_fields`:

*  `auth_user` и `auth_pw` - если `host_name` закрыт с помощью http-авторизации
*  `fonts.css` - относительный путь до css файла с шрифтами для подключения к редактору (описан ниже)
*  любые дополнительные данные (будут возвращены при сохранении статьи в неизменном виде)

В ответ Verstka API вернет в виде JSON следующие поля данных:

*  `session_id` - уникальный идентификатор сессии редактирования
*  `edit_url` - URL страницы редактора для этой сессии

Так же в ответе будут дополнительные поля: 

*  `last_save` - время последнего сохранения статьи (в случае если статья недавно редактировалась)
*  `contents` - URL для получения содержимого сессии редактирования (необходим только для интеграции без `callback_url`)
*  `client_folder` - вычисленный относительный URL до статического контента статьи на `host_name` (для debug) 

В случае если редактору не удастся скачать некоторые изображения статьи вернутся следующие дополнительные параметры:

*  `lacking_pictures` - список недостающих изображений
*  `upload_url` - URL для загрузки по средствам POST multipart/form-data

##Сохранение статьи

Сохранение статьи доступно в техении 48 часов с последнего взаимодействия (открытия или предыдущего сохранения) этой статьи

При нажатии пользователем кнопки сохранить в редакторе будет запрошен `callback_url` и с помощью POST переданы следующие параметры:

*  `material_id` - идентификатор сохраняемого материала
*  `user_id` - идентификатор текущего пользователя
*  `session_id` - уникальный идентификатор сессии редактирования
*  `html_body` - html сохраняемой статьи
*  `download_url` - URL для скачивания статического контента
*  `custom_fields` - JSON с дополнительными полями переданными при открытии редактора
*  `callback_sign` - цифорвая подпись запроса генерируемая по следующему алгоритму:

md5 от сконкатенированых параметров в следующем порядке: secret, session_id, user_id, material_id, download_url, где
`secret` - ключ выдаваемый при подключении к Verstka SaaS API

Изображения статьи доступны по адресу `download_url` (возвращает список) и `download_url`/`name` (возвращает файл),
где `name` - имя файла для скачивания.


```
<?php
  include __DIR__.'/vendor/vms/class.VMSsdk.php';
  $verstka = new \devnow\VMSsdk($apikey, $secret, $call_back_url, $call_back_function, $temp_dir_abs, $web_root_abs);
php?>
```
* Значения `$apikey` и `$secret` выдаются клиенту при интеграции.
* `$call_back_url` – URL для сохранения материалов (по этому URL необходимо разместить создание экземпляра класса как описано выше)
* `$call_back_function` – функция для сохранения материала в БД и перемещения изображений из временной директории в папку изображений на вашем сайте
* `$temp_dir_abs` – абсолютный путь на файловой системе сервера для хранения временных файлов при работе с редактором
* `$web_root_abs` – абсолютный путь на файловой системе сервера где расположена корневая папка сайта

Данный код осуществляет:
* скачивание изображений в директорию временных файлов `$temp_dir_abs`
* передачу функции обратного вызова `$call_back_function`, которая будет вызвана при сохранении материала

##Создание и редактирование материалов

После создания экземпляра класса вызовом $verstka = new \devnow\VMSsdk(...) как показано выше нужно выполнить вашу процедру авторизации. Это необходимо сделать после т.к. конструктор класса VMSsdk автоматически проверяет загаловки текущего запроса на признаки калбека от Verstka.io о сохранении статьи. Если так и есть он самостоятельно проверит валидность запроса и скачает изображения и вызовет вашу функцию сохранения.

###Связка с местной авторизацией

При попытке открыть URL для редактирования материала местная авторизация должна:<br>
* проверить наличие необходимых прав у текущего пользователя
* определить `user_id`, который будет передан в `$call_back_function`

###Запрос к БД
После этого необходимо запросить из БД текущий HTML статьи.<br>
Например, запрос может выглядеть так:
```
select vms_content from t_materials where is_vms = true and material_id = [MATERIAL_ID]
```

###Получение ссылки на редактирование
Далее осуществляется запроск серверу **Verstka** для создания сессии.<br>
Запрашиваем URL этой сессии:

```
<?php
  $result = $verstka->edit($outgoing['vms_content'], $params['material_id'], $auth['user_id'], $custom_fields);
  
  if (!empty($result['edit_url'])) {
    header('Location: ' . $result['edit_url']);
    echo '<a href="' . $result['edit_url'] . '" target="_blank">Edit ' . $result['edit_url'] . '</a>';
  } else {
    print_r($result);
  }
  
  die;
php?>
```

Массив `$custom_fields` может содержать дополнительные параметры, которые вы захотите использовать в будущем, например:

`$custom_fileds['edit_link']` – абсолютный URL для редактирования текущей статьи

`$custom_fileds['fonts.css']` – относительный путь на вашем сервере где хранится css для подключения ваших шрифтов к редактору верстка, формат такого файла описан ниже;

##Использование собственных шрифтов

Нужно собрать css файл с определенными комментариями и зашитыми в base64 шрифтами и тогда они автоматически появятся в Верстке.

Вверху css файла нужно в комментах указать дефолтный шрифт, который будет выставляться при создании нового текстового объекта.
```
/* default_font_family: 'formular'; */
/* default_font_weight: 400; */
/* default_font_size: 16px; */
/* default_line_height: 24px; */
```

Далее, для каждого `@font-face` нужно прописать комментарии с названием шрифта и его начертанием
```
  /* font_name: 'Formular'; */
  /* font_style_name: 'Light'; */
```

Итоговый css файл:
```
/* default_font_family: 'formular'; */
/* default_font_weight: 400; */
/* default_font_size: 16px; */
/* default_line_height: 24px; */

@font-face {
  /* font_name: 'Formular'; */
  /* font_style_name: 'Light'; */
   font-family: 'formular';
   src: url(data:application/font-woff2;charset=utf-8;base64,KJHGKJHGJHG) format('woff2'),
        url(data:application/font-woff;charset=utf-8;base64,KJHGKJHGJHG) format('woff');
   font-weight: 300;
   font-style: normal;
}

@font-face {
  /* font_name: 'Formular'; */
  /* font_style_name: 'Regular; */
   font-family: 'formular';
   src: url(data:application/font-woff2;charset=utf-8;base64,KJHGKJHGJHG) format('woff2'),
        url(data:application/font-woff;charset=utf-8;base64,KJHGKJHGJHG) format('woff');
   font-weight: 400;
   font-style: normal;
}
```


